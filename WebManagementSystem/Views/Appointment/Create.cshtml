@model WebManagementSystem.Models.ViewModels.CreateAppointmentViewModel
@{
    Layout = "_Layout";
}

<style>
    :root {
        --gradient-start: #8d79ff;
        --gradient-end: #ff9b61;
        --gold-light: #ffce70;
    }

    body {
        background: radial-gradient(circle at top left, #20254a, #050816 60%);
        color: white;
        font-family: 'Segoe UI', sans-serif;
    }

    .form-card {
        margin: auto;
        margin-top: 3rem;
        width: 60%;
        max-width: 700px;
        background: rgba(255,255,255,0.08);
        padding: 2.5rem;
        border-radius: 20px;
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.15);
        box-shadow: 0 10px 25px rgba(0,0,0,0.45);
    }

    h2 {
        margin-bottom: 1.5rem;
        color: var(--gold-light);
        font-size: 2rem;
        background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
        -webkit-background-clip: text;
        color: transparent;
    }

    label {
        display: block;
        margin-bottom: .5rem;
        color: #e3e6ff;
        font-weight: 600;
        font-size: 0.95rem;
    }

    select, input, textarea {
        width: 100%;
        padding: .8rem;
        margin-bottom: 1.2rem;
        border-radius: 12px;
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.2);
        color: white;
        font-size: 1rem;
    }

    select option {
        background-color: #0d1128;
        color: white;
    }

    .submit-btn {
        padding: .9rem 2rem;
        background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
        border: none;
        border-radius: 12px;
        color: white;
        font-weight: 700;
        font-size: 1rem;
        cursor: pointer;
        width: 100%;
        transition: transform 0.2s;
    }

    .submit-btn:hover {
        transform: translateY(-2px);
    }

    .submit-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .info-message {
        padding: 1rem;
        background: rgba(255,193,7,0.15);
        border-left: 3px solid #ffc107;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        color: #ffc107;
        font-size: 0.9rem;
    }

    .loading {
        color: #bebfe7;
        font-style: italic;
    }

    .no-slots {
        color: #ff6b6b;
        padding: 1rem;
        background: rgba(255,107,107,0.15);
        border-radius: 8px;
        margin-top: 0.5rem;
    }
</style>

<div class="form-card">
    <h2>📅 Book Appointment</h2>

    @if (TempData["ErrorMessage"] != null)
    {
        <div style="padding: 1rem; background: rgba(255,107,107,0.15); border-left: 3px solid #ff6b6b; border-radius: 8px; margin-bottom: 1.5rem; color: #ff6b6b;">
            @TempData["ErrorMessage"]
        </div>
    }

    <form asp-action="Create" method="post" id="appointmentForm">
        @Html.AntiForgeryToken()

        @if (Model.PatientId > 0)
        {
            <input type="hidden" asp-for="PatientId" />
        }
        else if (Model.AvailablePatients != null && Model.AvailablePatients.Any())
        {
            <label>Select Patient *</label>
            <select asp-for="PatientId" required>
                <option value="">-- Select Patient --</option>
                @foreach (var patient in Model.AvailablePatients)
                {
                    <option value="@patient.PatientId">@patient.FullName - @patient.Phone</option>
                }
            </select>
        }

        <!-- SELECT DOCTOR -->
        <label>Select Doctor *</label>
        <select id="doctorSelect" asp-for="DoctorId" required>
            <option value="">-- Select a Doctor --</option>
            @if (Model.AvailableDoctors != null)
            {
                @foreach (var doctor in Model.AvailableDoctors)
                {
                    <option value="@doctor.DoctorId">@doctor.FullName</option>
                }
            }
        </select>

        <!-- SELECT DATE -->
        <label>Select Date *</label>
        <input type="date" id="dateSelect" asp-for="ScheduledDate" required min="@DateTime.Today.ToString("yyyy-MM-dd")" />

        <!-- AVAILABLE TIME SLOTS -->
        <label>Available Time Slots *</label>
        <select id="timeSlotSelect" asp-for="ScheduleId" required disabled>
            <option value="">-- Select doctor and date first --</option>
        </select>
        <div id="slotInfo" style="margin-top: 0.5rem;"></div>

        <!-- REASON -->
        <label>Reason for Appointment *</label>
        <textarea asp-for="Reason" rows="4" placeholder="Describe your symptoms or reason for the appointment..." required></textarea>

        <button type="submit" class="submit-btn" id="submitBtn" disabled>Book Appointment</button>
    </form>
</div>

<script>
    const doctorSelect = document.getElementById("doctorSelect");
    const dateSelect = document.getElementById("dateSelect");
    const slotSelect = document.getElementById("timeSlotSelect");
    const slotInfo = document.getElementById("slotInfo");
    const submitBtn = document.getElementById("submitBtn");

    function updateSlots() {
        const doctorId = doctorSelect.value;
        const date = dateSelect.value;

        if (!doctorId || !date) {
            slotSelect.innerHTML = '<option value="">-- Select doctor and date first --</option>';
            slotSelect.disabled = true;
            submitBtn.disabled = true;
            slotInfo.innerHTML = '';
            return;
        }

        slotSelect.innerHTML = '<option value="">Loading slots...</option>';
        slotSelect.disabled = true;
        submitBtn.disabled = true;
        slotInfo.innerHTML = '<span class="loading">Loading available time slots...</span>';

        fetch(`/Appointment/GetAvailableSlots?doctorId=${doctorId}&date=${date}`)
            .then(r => r.json())
            .then(slots => {
                slotSelect.innerHTML = '';
                
                if (slots.length === 0) {
                    slotSelect.innerHTML = '<option value="">No available slots</option>';
                    slotSelect.disabled = true;
                    submitBtn.disabled = true;
                    slotInfo.innerHTML = '<div class="no-slots">No available time slots for this doctor on the selected date. Please select a different date or doctor.</div>';
                } else {
                    slotSelect.innerHTML = '<option value="">-- Select a time slot --</option>';
                    slots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot.scheduleId;
                        option.textContent = slot.displayTime;
                        slotSelect.appendChild(option);
                    });
                    slotSelect.disabled = false;
                    slotInfo.innerHTML = `<span style="color: #28a745;">${slots.length} available slot(s)</span>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                slotSelect.innerHTML = '<option value="">Error loading slots</option>';
                slotSelect.disabled = true;
                submitBtn.disabled = true;
                slotInfo.innerHTML = '<div class="no-slots">Error loading time slots. Please try again.</div>';
            });
    }

    doctorSelect.addEventListener("change", updateSlots);
    dateSelect.addEventListener("change", updateSlots);
    
    slotSelect.addEventListener("change", function() {
        submitBtn.disabled = !slotSelect.value;
    });

    // Set minimum date to today
    dateSelect.min = new Date().toISOString().split('T')[0];
</script>
